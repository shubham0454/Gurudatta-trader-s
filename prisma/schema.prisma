// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Admin {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  mobileNo  String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

model User {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userCode    String   @unique // Unique code for each user (creates index automatically)
  name        String
  mobileNo    String
  address     String?
  email       String?
  userType    String   @default("BMC") // BMC, Dabhadi, or Customer
  status      String   @default("active") // active or inactive
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  transactions Transaction[]
  bills       Bill[]

  @@index([mobileNo])
  @@index([userType])
  @@index([status])
  @@map("users")
}

model Feed {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   // e.g., "Tiwana"
  brand       String?
  weight      Float    // in kg (25, 50, etc.)
  defaultPrice Float   // default price per unit
  stock       Float    @default(0) // remaining stock in godown
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  billItems   BillItem[]

  @@index([name])
  @@map("feeds")
}

model Bill {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  billNumber  String   @unique
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  totalAmount Float
  paidAmount  Float    @default(0)
  pendingAmount Float  // totalAmount - paidAmount
  status      String   @default("pending") // pending, partial, paid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  items       BillItem[]
  transactions Transaction[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("bills")
}

model BillItem {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  billId      String   @db.ObjectId
  bill        Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  feedId      String   @db.ObjectId
  feed        Feed     @relation(fields: [feedId], references: [id])
  quantity    Float
  unitPrice   Float    // custom price or default price
  totalPrice  Float    // quantity * unitPrice
  createdAt   DateTime @default(now())

  @@index([billId])
  @@index([feedId])
  @@map("billitems")
}

model Transaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  billId      String?  @db.ObjectId
  bill        Bill?    @relation(fields: [billId], references: [id], onDelete: SetNull)
  amount      Float
  type        String   // payment, purchase
  description String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([billId])
  @@index([createdAt])
  @@index([type])
  @@map("transactions")
}

